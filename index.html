document.addEventListener("DOMContentLoaded", function () {
    console.log("üìå Technische Analyse geladen!");
    loadTechAnalysis(); // Laad bestaande analyses bij start
});

const apiUrl = "http://13.60.235.90:5002/technical_analysis"; // ‚úÖ API endpoint

// ‚úÖ **Technische Analyse laden vanaf API**
async function loadTechAnalysis() {
    try {
        let response = await fetch(apiUrl);
        if (!response.ok) throw new Error("‚ùå Fout bij ophalen technische analyse");

        let data = await response.json();
        console.log("üìä Ontvangen technische analyse data:", data);
        renderTechTable(data);
    } catch (error) {
        console.error(error);
        alert("‚ùå Er is een fout opgetreden bij het laden van de technische analyse.");
    }
}

// ‚úÖ **Tabel genereren op basis van data**
function renderTechTable(data) {
    let tableBody = document.getElementById("analysisTable").getElementsByTagName("tbody")[0];
    tableBody.innerHTML = ""; // Tabel opschonen

    data.assets.forEach(asset => {
        let newRow = tableBody.insertRow();
        newRow.insertCell(0).innerText = asset.name;

        asset.indicators.forEach(indicator => {
            let newCell = newRow.insertCell(-1);
            newCell.innerText = indicator.value;
        });

        let deleteCell = newRow.insertCell(-1);
        deleteCell.innerHTML = `<button class="btn-remove" onclick="removeTechRow('${asset.id}', this)">‚ùå</button>`;
    });
}

// ‚úÖ **Asset toevoegen met bestaande indicatoren**
window.addTechRow = async function () {
    let assetName = prompt("üîπ Voer de naam van de asset in:");
    if (!assetName) return;

    try {
        let response = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name: assetName, indicators: [] })
        });

        if (!response.ok) throw new Error("‚ùå Fout bij toevoegen asset");

        loadTechAnalysis(); // **Direct herladen**
        alert("‚úÖ Asset succesvol toegevoegd!");
    } catch (error) {
        console.error(error);
        alert("‚ùå Asset toevoegen mislukt.");
    }
};

// ‚úÖ **Indicator toevoegen aan alle assets**
window.addTechIndicator = async function () {
    let indicatorName = prompt("üìä Voer de naam van de indicator in:");
    if (!indicatorName) return;

    try {
        let response = await fetch(`${apiUrl}/indicators`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name: indicatorName })
        });

        if (!response.ok) throw new Error("‚ùå Fout bij toevoegen indicator");

        loadTechAnalysis();
        alert("‚úÖ Indicator succesvol toegevoegd!");
    } catch (error) {
        console.error(error);
        alert("‚ùå Indicator toevoegen mislukt.");
    }
};

// ‚úÖ **Asset verwijderen met directe UI-feedback**
window.removeTechRow = async function (assetId, button) {
    button.disabled = true; // **Knop uitschakelen om dubbel klikken te voorkomen**
    try {
        let response = await fetch(`${apiUrl}/${assetId}`, { method: "DELETE" });
        if (!response.ok) throw new Error("‚ùå Fout bij verwijderen asset");

        loadTechAnalysis();
        alert("‚úÖ Asset succesvol verwijderd!");
    } catch (error) {
        console.error(error);
        alert("‚ùå Asset verwijderen mislukt.");
    } finally {
        button.disabled = false; // **Knop weer inschakelen**
    }
};

// ‚úÖ **Indicator verwijderen**
window.removeTechIndicator = async function (button) {
    let indicatorName = button.parentNode.textContent.trim();

    try {
        let response = await fetch(`${apiUrl}/indicators/${indicatorName}`, { method: "DELETE" });
        if (!response.ok) throw new Error("‚ùå Fout bij verwijderen indicator");

        loadTechAnalysis();
        alert("‚úÖ Indicator succesvol verwijderd!");
    } catch (error) {
        console.error(error);
        alert("‚ùå Indicator verwijderen mislukt.");
    }
};
