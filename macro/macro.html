<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ“Š Macro Indicatoren</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="macro-container">
  <h2>ğŸ“Š Macro Indicatoren</h2>

  <button class="btn-add" onclick="addMacroRow()">â• Indicator toevoegen</button>

  <table id="macroTable">
    <thead>
      <tr>
        <th>Indicator</th>
        <th>Huidig Niveau</th>
        <th>Trend</th>
        <th>Interpretatie</th>
        <th>Actie</th>
        <th>Score</th>
        <th>Verwijderen</th>
      </tr>
    </thead>
    <tbody id="macroBody">
      <tr>
        <td>Fear & Greed Index</td>
        <td id="fearGreed">ğŸ“¡ Laden...</td>
        <td id="fearGreedTrend" class="trend-cell">N/A</td>
        <td id="fearGreedInterpretation">N/A</td>
        <td id="fearGreedAction">N/A</td>
        <td class="macro-score" id="fearGreedScore">-</td>
        <td><button class="btn-remove" onclick="removeRow(this)">âŒ</button></td>
      </tr>
      <tr>
        <td>Bitcoin Dominantie</td>
        <td id="btcDominance">ğŸ“¡ Laden...</td>
        <td id="btcDominanceTrend" class="trend-cell">N/A</td>
        <td id="btcDominanceInterpretation">N/A</td>
        <td id="btcDominanceAction">N/A</td>
        <td class="macro-score" id="btcDominanceScore">-</td>
        <td><button class="btn-remove" onclick="removeRow(this)">âŒ</button></td>
      </tr>
      <tr>
        <td>Dollar Index (DXY)</td>
        <td id="dxy">ğŸ“¡ Laden...</td>
        <td id="dxyTrend" class="trend-cell">N/A</td>
        <td id="dxyInterpretation">N/A</td>
        <td id="dxyAction">N/A</td>
        <td class="macro-score" id="dxyScore">-</td>
        <td><button class="btn-remove" onclick="removeRow(this)">âŒ</button></td>
      </tr>
    </tbody>
  </table>

  <h3>ğŸŒ Totale Macro Score: <span id="macroTotalScore">N/A</span></h3>
  <h3>ğŸ“ˆ Macro Advies: <span id="macroAdvice">Neutraal</span></h3>
  <p id="macroStatus" class="loading">ğŸ“¡ Data laden...</p>
</div>

<script type="module">
  import { API_BASE_URL } from "../config.js";

  const indicators = {
    "fearGreed": { thresholds: [30, 50, 70], positive: true },
    "btcDominance": { thresholds: [45, 50, 55], positive: true },
    "dxy": { thresholds: [100, 103, 106], positive: false }
  };

  async function fetchMacroData() {
    try {
      const response = await fetch(`${API_BASE_URL}/macro_data`);
      if (!response.ok) throw new Error("Fout bij ophalen macro-data");
      const data = await response.json();

      Object.keys(indicators).forEach(id => {
        const value = data[id] ?? "N/A";
        const { thresholds, positive } = indicators[id];
        updateMacroIndicator(id, value, thresholds, positive);
      });

      updateMacroScore();
      document.getElementById("macroStatus").textContent = "âœ… Macrodata up-to-date";

      markStepDone(3); // âœ… Onboarding stap 3 voltooid

    } catch (error) {
      console.error("âŒ Macrodata ophalen mislukt:", error);
      document.getElementById("macroStatus").textContent = "âŒ Fout bij ophalen macro-data.";
    }
  }

  function updateMacroIndicator(id, value, thresholds, positive) {
    const el = document.getElementById(id);
    const trendEl = document.getElementById(`${id}Trend`);
    const interpEl = document.getElementById(`${id}Interpretation`);
    const actionEl = document.getElementById(`${id}Action`);
    const scoreEl = document.getElementById(`${id}Score`);

    el.textContent = `${value}${id === "btcDominance" ? "%" : ""}`;
    const score = calculateScore(value, thresholds, positive);
    scoreEl.textContent = score;

    const trend = score >= 1 ? "Bullish ğŸ“ˆ" : score <= -1 ? "Bearish ğŸ“‰" : "Neutraal âš–ï¸";
    const interp = score >= 1 ? "Positief signaal" : score <= -1 ? "Negatief signaal" : "Geen duidelijke richting";
    const action = score >= 1 ? "Overwegen om te kopen ğŸŸ¢" : score <= -1 ? "Voorzichtigheid geboden ğŸ”´" : "Geen actie nodig";

    trendEl.textContent = trend;
    interpEl.textContent = interp;
    actionEl.textContent = action;

    trendEl.classList.remove("bullish", "bearish", "neutral");
    trendEl.classList.add(score >= 1 ? "bullish" : score <= -1 ? "bearish" : "neutral");
  }

  function calculateScore(value, thresholds, positive) {
    if (isNaN(value)) return "N/A";
    value = parseFloat(value);

    return positive
      ? value > thresholds[2] ? 2 : value > thresholds[1] ? 1 : value > thresholds[0] ? -1 : -2
      : value < thresholds[0] ? 2 : value < thresholds[1] ? 1 : value < thresholds[2] ? -1 : -2;
  }

  function updateMacroScore() {
    let total = 0, count = 0;
    document.querySelectorAll(".macro-score").forEach(cell => {
      const score = parseInt(cell.textContent);
      if (!isNaN(score)) {
        total += score;
        count++;
      }
    });

    const avg = count > 0 ? (total / count).toFixed(1) : "N/A";
    document.getElementById("macroTotalScore").textContent = avg;
    updateMacroAdvice(avg);
  }

  function updateMacroAdvice(score) {
    const advice = score >= 1.5 ? "ğŸŸ¢ Bullish" : score <= -1.5 ? "ğŸ”´ Bearish" : "âš–ï¸ Neutraal";
    document.getElementById("macroAdvice").textContent = advice;
  }

  function addMacroRow() {
    const table = document.getElementById("macroTable").getElementsByTagName('tbody')[0];
    const newRow = table.insertRow();
    newRow.innerHTML = `
      <td><input type="text" placeholder="Naam Indicator"></td>
      <td>Laden...</td>
      <td>N/A</td>
      <td>N/A</td>
      <td>N/A</td>
      <td class="macro-score">-</td>
      <td><button class="btn-remove" onclick="removeRow(this)">âŒ</button></td>
    `;
  }

  function removeRow(btn) {
    const row = btn.parentNode.parentNode;
    row.parentNode.removeChild(row);
    updateMacroScore();
  }

  function markStepDone(step) {
    const userId = localStorage.getItem("user_id");
    if (!userId) return;

    fetch(`${API_BASE_URL}/api/onboarding_progress/${userId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ step })
    }).then(res => {
      if (!res.ok) console.warn("âš ï¸ Stap niet bijgewerkt");
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    fetchMacroData();
    setInterval(fetchMacroData, 60000);
  });
</script>
</body>
</html>
