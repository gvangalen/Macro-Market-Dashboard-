<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š Macro Indicatoren</title>
    <link rel="stylesheet" href="styles.css"> <!-- âœ… Voeg CSS toe -->
</head>
<body>

<div class="macro-container">
    <h2>ğŸ“Š Macro Indicatoren</h2>
    
    <button class="btn-add" onclick="addMacroRow()">â• Indicator toevoegen</button>

    <table id="macroTable">
        <thead>
            <tr>
                <th>Indicator</th>
                <th>Huidig Niveau</th>
                <th>Trend</th>
                <th>Interpretatie</th>
                <th>Actie</th>
                <th>Score</th>
                <th>Verwijderen</th>
            </tr>
        </thead>
        <tbody id="macroBody">
            <tr>
                <td>Fear & Greed Index</td>
                <td id="fearGreed">ğŸ“¡ Laden...</td>
                <td id="fearGreedTrend" class="trend-cell">N/A</td>
                <td id="fearGreedInterpretation">N/A</td>
                <td id="fearGreedAction">N/A</td>
                <td class="macro-score" id="fearGreedScore">-</td>
                <td><button class="btn-remove" onclick="removeRow(this)">âŒ</button></td>
            </tr>
            <tr>
                <td>Bitcoin Dominantie</td>
                <td id="btcDominance">ğŸ“¡ Laden...</td>
                <td id="btcDominanceTrend" class="trend-cell">N/A</td>
                <td id="btcDominanceInterpretation">N/A</td>
                <td id="btcDominanceAction">N/A</td>
                <td class="macro-score" id="btcDominanceScore">-</td>
                <td><button class="btn-remove" onclick="removeRow(this)">âŒ</button></td>
            </tr>
            <tr>
                <td>Dollar Index (DXY)</td>
                <td id="dxy">ğŸ“¡ Laden...</td>
                <td id="dxyTrend" class="trend-cell">N/A</td>
                <td id="dxyInterpretation">N/A</td>
                <td id="dxyAction">N/A</td>
                <td class="macro-score" id="dxyScore">-</td>
                <td><button class="btn-remove" onclick="removeRow(this)">âŒ</button></td>
            </tr>
        </tbody>
    </table>

    <h3>ğŸŒ Totale Macro Score: <span id="macroTotalScore">N/A</span></h3>
    <h3>ğŸ“ˆ Macro Advies: <span id="macroAdvice">Neutraal</span></h3>
    <p id="macroStatus" class="loading">ğŸ“¡ Data laden...</p>
</div>

<script>
    const API_BASE_URL = "http://13.60.235.90:5002"; // âœ… AWS API-endpoint

    // âœ… **Macro-indicatoren met drempelwaarden**
    const indicators = {
        "fearGreed": { thresholds: [30, 50, 70], positive: true },
        "btcDominance": { thresholds: [45, 50, 55], positive: true },
        "dxy": { thresholds: [100, 103, 106], positive: false }
    };

    // âœ… **Haalt macro-data op en werkt de UI bij**
    async function fetchMacroData() {
        try {
            let response = await fetch(`${API_BASE_URL}/macro_data`);
            if (!response.ok) throw new Error("Fout bij ophalen macro-data");

            let data = await response.json();
            console.log("ğŸ“Š Ontvangen Macro Data:", data);

            // âœ… **Update indicatoren**
            Object.keys(indicators).forEach(id => {
                let value = data[id] ?? "N/A"; // Fallback als waarde ontbreekt
                let { thresholds, positive } = indicators[id];

                updateMacroIndicator(id, value, thresholds, positive);
            });

            updateMacroScore();
            document.getElementById("macroStatus").textContent = "âœ… Macrodata up-to-date";
        } catch (error) {
            console.error("âŒ Macrodata ophalen mislukt:", error);
            document.getElementById("macroStatus").textContent = "âŒ Fout bij ophalen macro-data.";
        }
    }

    // âœ… **Update een macro-indicator in de DOM en bereken score**
    function updateMacroIndicator(id, value, thresholds, positive) {
        let valueElement = document.getElementById(id);
        let trendElement = document.getElementById(`${id}Trend`);
        let interpretationElement = document.getElementById(`${id}Interpretation`);
        let actionElement = document.getElementById(`${id}Action`);
        let scoreElement = document.getElementById(`${id}Score`);

        valueElement.textContent = `${value}${id === "btcDominance" ? "%" : ""}`;

        let score = calculateScore(value, thresholds, positive);
        scoreElement.textContent = score;

        let trend = score >= 1 ? "Bullish ğŸ“ˆ" : score <= -1 ? "Bearish ğŸ“‰" : "Neutraal âš–ï¸";
        trendElement.textContent = trend;

        let interpretation = score >= 1 ? "Positief signaal" : score <= -1 ? "Negatief signaal" : "Geen duidelijke richting";
        interpretationElement.textContent = interpretation;

        let action = score >= 1 ? "Overwegen om te kopen ğŸŸ¢" : score <= -1 ? "Voorzichtigheid geboden ğŸ”´" : "Geen actie nodig";
        actionElement.textContent = action;

        // âœ… **Voeg kleur toe op basis van trend**
        trendElement.classList.remove("bullish", "bearish", "neutral");
        if (score >= 1) trendElement.classList.add("bullish");
        else if (score <= -1) trendElement.classList.add("bearish");
        else trendElement.classList.add("neutral");
    }

    // âœ… **Score berekenen op basis van thresholds**
    function calculateScore(value, thresholds, positive) {
        if (isNaN(value)) return "N/A";
        value = parseFloat(value);

        if (positive) {
            return value > thresholds[2] ? 2 : value > thresholds[1] ? 1 : value > thresholds[0] ? -1 : -2;
        } else {
            return value < thresholds[0] ? 2 : value < thresholds[1] ? 1 : value < thresholds[2] ? -1 : -2;
        }
    }

    // âœ… **Totale macro-score berekenen**
    function updateMacroScore() {
        let scores = document.querySelectorAll(".macro-score");
        let totalScore = 0, count = 0;

        scores.forEach(cell => {
            let score = parseInt(cell.textContent);
            if (!isNaN(score)) {
                totalScore += score;
                count++;
            }
        });

        let avgScore = count > 0 ? (totalScore / count).toFixed(1) : "N/A";
        document.getElementById("macroTotalScore").textContent = avgScore;
        updateMacroAdvice(avgScore);
    }

    // âœ… **Advies genereren op basis van macro-score**
    function updateMacroAdvice(score) {
        let advice = score >= 1.5 ? "Bullish ğŸŸ¢" : score <= -1.5 ? "Bearish ğŸ”´" : "Neutraal âš–ï¸";
        document.getElementById("macroAdvice").textContent = advice;
    }

    // âœ… **Indicator handmatig toevoegen**
    function addMacroRow() {
        let table = document.getElementById("macroTable").getElementsByTagName('tbody')[0];
        let newRow = table.insertRow();

        newRow.innerHTML = `
            <td><input type="text" placeholder="Naam Indicator"></td>
            <td>Laden...</td>
            <td>N/A</td>
            <td>N/A</td>
            <td>N/A</td>
            <td class="macro-score">-</td>
            <td><button class="btn-remove" onclick="removeRow(this)">âŒ</button></td>
        `;
    }

    function removeRow(button) {
        let row = button.parentNode.parentNode;
        row.parentNode.removeChild(row);
        updateMacroScore();
    }

    document.addEventListener("DOMContentLoaded", function () {
        fetchMacroData();
        setInterval(fetchMacroData, 60000);
    });
</script>
