<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📊 Dashboard</title>
    <link rel="stylesheet" href="dashboard/dashboard.css"> <!-- ✅ Aangepast pad -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- ✅ Laadt Chart.js -->
</head>
<body>

<div class="table-container">
    <h2>📊 Dashboard</h2>
    <p id="dashboardStatus" class="loading">📡 Data laden...</p>

    <div class="dashboard-container">
        <!-- Macro Gauge -->
        <div class="gauge-wrapper">
            <canvas id="macroGauge"></canvas>
            <span>📉 Macro</span>
        </div>

        <!-- Technical Gauge -->
        <div class="gauge-wrapper">
            <canvas id="technicalGauge"></canvas>
            <span>📈 Technisch</span>
        </div>

        <!-- Setup Gauge -->
        <div class="gauge-wrapper">
            <canvas id="setupGauge"></canvas>
            <span>📊 Setup</span>
        </div>
    </div>

    <!-- Macro Indicatoren Tabel -->
    <h3>📊 Macro Indicatoren</h3>
    <table id="macroTable">
        <thead>
            <tr>
                <th>Indicator</th>
                <th>Waarde</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Technical Indicatoren Tabel -->
    <h3>📊 Technische Indicatoren</h3>
    <table id="technicalTable">
        <thead>
            <tr>
                <th>Indicator</th>
                <th>Waarde</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Setup Tabel -->
    <h3>📊 Setups</h3>
    <table id="setupTable">
        <thead>
            <tr>
                <th>Setup</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

</div>

<!-- ✅ JavaScript-bestanden laden -->
<script>
    console.log("✅ Dashboard.js geladen!");

    const API_BASE_URL = "http://13.60.235.90:5002"; // ✅ AWS API-endpoint
    let macroGauge, technicalGauge, setupGauge;

    document.addEventListener("DOMContentLoaded", function () {
        console.log("📌 Dashboard wordt geladen...");
        macroGauge = createGauge("macroGauge");
        technicalGauge = createGauge("technicalGauge");
        setupGauge = createGauge("setupGauge");

        fetchDashboardData();
        setInterval(fetchDashboardData, 60000); // 🔄 Elke minuut updaten
    });

    async function fetchDashboardData() {
        try {
            let response = await fetch(`${API_BASE_URL}/dashboard_data`);
            if (!response.ok) throw new Error("Fout bij ophalen dashboard-data");

            let data = await response.json();
            console.log("📊 Dashboard API data:", data);

            // ✅ Validatie van de ontvangen data
            if (!data.macroScore || !data.technicalScore || !data.activeSetups) {
                throw new Error("❌ Ontbrekende gegevens in de API-respons");
            }

            updateGauge(macroGauge, data.macroScore);
            updateGauge(technicalGauge, data.technicalScore);
            updateGauge(setupGauge, data.activeSetups);

            document.getElementById("dashboardStatus").textContent = "✅ Dashboard up-to-date!";

            // Update de tabellen met macro en technische gegevens
            renderMacroTable(data.macroIndicators);
            renderTechnicalTable(data.technicalIndicators);
            renderSetupTable(data.setups);

        } catch (error) {
            console.error("❌ Dashboard API-fout:", error);
            document.getElementById("dashboardStatus").textContent = "❌ Fout bij laden dashboard-data.";
        }
    }

    function createGauge(elementId) {
        const ctx = document.getElementById(elementId).getContext("2d");
        return new Chart(ctx, {
            type: "doughnut",
            data: {
                labels: ["Bearish", "Neutraal", "Bullish"],
                datasets: [{
                    data: [33, 34, 33], // Gelijke verdeling in begin
                    backgroundColor: ["#ff3b30", "#f0ad4e", "#34c759"],
                    borderWidth: 0
                }]
            },
            options: {
                rotation: -90,
                circumference: 180,
                cutout: "80%",
                plugins: { legend: { display: false }, tooltip: { enabled: false } }
            }
        });
    }

    function updateGauge(gauge, score) {
        if (!gauge) return;
        let index = score >= 1 ? 2 : score <= -1 ? 0 : 1;
        gauge.data.datasets[0].data = [index === 0 ? 100 : 33, index === 1 ? 100 : 33, index === 2 ? 100 : 33];
        gauge.update();
    }

    // ✅ Render Macro Indicatoren Tabel
    function renderMacroTable(data) {
        let tableBody = document.getElementById("macroTable").getElementsByTagName("tbody")[0];
        tableBody.innerHTML = "";
        data.forEach(indicator => {
            let newRow = tableBody.insertRow();
            newRow.insertCell(0).innerText = indicator.name;
            newRow.insertCell(1).innerText = indicator.value;
        });
    }

    // ✅ Render Technical Indicatoren Tabel
    function renderTechnicalTable(data) {
        let tableBody = document.getElementById("technicalTable").getElementsByTagName("tbody")[0];
        tableBody.innerHTML = "";
        data.forEach(indicator => {
            let newRow = tableBody.insertRow();
            newRow.insertCell(0).innerText = indicator.name;
            newRow.insertCell(1).innerText = indicator.value;
        });
    }

    // ✅ Render Setup Tabel
    function renderSetupTable(data) {
        let tableBody = document.getElementById("setupTable").getElementsByTagName("tbody")[0];
        tableBody.innerHTML = "";
        data.forEach(setup => {
            let newRow = tableBody.insertRow();
            newRow.insertCell(0).innerText = setup.name;
            newRow.insertCell(1).innerText = setup.status;
        });
    }
</script>

</body>
</html>
